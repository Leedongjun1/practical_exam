<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.practical.exam.cms.login.dao.LoginDao">
	<resultMap id="getUserInfoReslt" type="Map">
	  <result column="USER_NO" 		property="userNo" 	javaType="String"/>
	  <result column="USER_ID" 		property="userId" 	javaType="String"/>
	  <result column="USER_PW"		property="userPw" 	javaType="String"/>
	  <result column="USER_SALT"	property="salt" 	javaType="String"/>
	  <result column="USER_NAME"	property="userNm" 	javaType="String"/>
	  <result column="USER_PHONE"	property="phone" 	javaType="String"/>
	</resultMap>
    <select id="getUserInfo" resultMap="getUserInfoReslt">
        SELECT USER_NO
        	 , USER_ID
        	 , USER_PW
        	 , USER_SALT
        	 , USER_NAME
        	 , USER_PHONE 
      	FROM P_MEMBER
      	WHERE USER_ID = #{userId}
      	AND USER_PW = #{password};
    </select>
    
    <select id="idDuplicated" resultType="boolean">
        SELECT CASE WHEN COUNT(*) = 0 THEN 0
        			ELSE 1 END  
      	FROM P_MEMBER
      	WHERE USER_ID = #{userId}
    </select>
    
    <insert id="addUserInfo" >
    
	   	INSERT INTO P_MEMBER 
	   		( USER_ID
	   		, USER_PW
	   		, USER_SALT
	   		, USER_NAME
	   		, USER_PHONE
	   		, REG_DATE
	    ) VALUES 
	   		( #{userId}
			, #{password}
			, ''
			, #{userName}
			, #{phoneNum}
			, SYSDATE()
		);  
    </insert>
    
    <select id="authNumberValid" resultType="boolean">
    
   		SELECT CASE WHEN COUNT(*) = 0 THEN 0 ELSE 1 END  
		from p_auth_number_log 
		where user_id = #{userId}
		and user_phone = #{phoneNum}
		and now() <![CDATA[<]]> DATE_ADD(auth_date, INTERVAL 3 MINUTE)
		and auth_num = #{authNumber}
		order by seq desc 
		limit 1;
	
    </select>
</mapper>

